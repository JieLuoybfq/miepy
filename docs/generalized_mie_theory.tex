\documentclass[11pt]{article}

% standard header for all latex files
\input{/home/john/.latex/standard_header.tex}

\usepackage[margin=.9in]{geometry}
\usepackage[labelfont=bf]{caption}
\usepackage{subcaption}
\usepackage{indentfirst}
\usepackage[affil-it]{authblk}
\usepackage{enumitem}
\usepackage{scrextend}
\usepackage{cleveref}

\usepackage[nottoc,notlot,notlof]{tocbibind}
\renewcommand{\bibname}{References}

\title{Generalized multiparticle Mie theory}
\date{}
\author{}

\begin{document}
\maketitle

\section{Vector spherical harmonic functions}

The generalized multiparticle Mie theory (GMMT) is outlined, following Xu's work. \cite{xu1995electromagnetic}
The vector spherical harmonic (VSH) functions are a complete basis set of the vector wave equations
\begin{align}
    \begin{split}
        \nabla \times \nabla \times \boldsymbol{E} &= k^2 \boldsymbol{E} \\
        \nabla \times \nabla \times \boldsymbol{H} &= k^2 \boldsymbol{H}
    \end{split}
\end{align}
They are defined as
\begin{align}
    \boldsymbol{M}_{mn}^{(J)} &= \big[
    \boldsymbol{\hat \theta} i\pi_{mn}(\cos\theta) 
   -\boldsymbol{\hat \phi} \tau_{mn}(\cos\theta) \big] z_n^{(J)}(kr) e^{im\phi} \\
    \boldsymbol{N}_{mn}^{(J)} &= 
    \boldsymbol{\hat r} n(n+1) P_n^m(\cos\theta) \frac{z_n^{(J)}(kr)}{kr}e^{im\phi} \\
    &\quad + \frac{1}{kr} \left[ \boldsymbol{\hat \theta} \tau_{mn}(\cos\theta) + \boldsymbol{\hat \phi} i\pi_{mn}(\cos\theta) \right]
    \frac{d}{dr} \left[ rz_n^{(J)}(kr)e^{im\phi} \right] \nonumber
\end{align}
where $J= 1,2,3,4$. The radial functions $z_n^{(J)}$ are
\begin{equation}
\begin{align*}
    z_n^{(1)}(x) &= j_n(x)  \qquad&  z_n^{(3)}(x) &= h_n^{(1)}(x) = j_n(x) + iy_n(x)   \\
z_n^{(2)}(x) &= y_n(x)  \qquad&  z_n^{(4)}(x) &= h_n^{(2)}(x) = j_n(x) - iy_n(x)
\end{align*}
\end{equation}
where $j_n$, $y_n$ are the spherical Bessel functions of the first and second kind, and $h_n^{(1)}$, $h_n^{(2)}$ are the spherical Hankel functions of the first and second kind.
The angular functions $\pi_{mn}$ and $\tau_{mn}$ are
\begin{align}
\pi_{mn}(\cos\theta) &= \frac{m}{\sin\theta} P_n^m(\cos\theta) \\
\tau_{mn}(\cos\theta) &= \frac{d}{d\theta} P_n^m(\cos\theta) 
\end{align}
The associated Legendre polynomials $P_n^m$ are defined without the Condon-Shortley phase, i.e.
\begin{equation}
P_n^m(x) = (1 - x^2)^{m/2} \frac{d^m}{dx^m} P_n(x)
\end{equation}
The VSHs are an orthogonal set when integrated over a closed surface $\Omega$
\begin{align}
\begin{split}
    \langle \boldsymbol{N}_{mn}^{(J)}, \boldsymbol{N}_{m^\prime n^\prime}^{(J)} \rangle
    &= \int_\Omega \boldsymbol{N}_{mn}^{(J)} \cdot \boldsymbol{N}_{m^\prime n^\prime}^{(J)*} \;d\Omega \\
    &= \delta_{mm^\prime}\delta_{nn^\prime}4\pi \frac{n(n+1)(n+m)!}{(2n+1)(n-m)!}
      \left[ \frac{\left|z_n^{(J)}(kr) + krz_n^{(J)\prime}(kr)\right|^2 + n(n+1) \left|z_n^{(J)}(kr)\right|^2 }{(kr)^2} \right] \\
    \langle \boldsymbol{M}_{mn}^{(J)}, \boldsymbol{M}_{m^\prime n^\prime}^{(J)} \rangle
    &= \int_\Omega \boldsymbol{M}_{mn}^{(J)} \cdot \boldsymbol{M}_{m^\prime n^\prime}^{(J)*} \;d\Omega
    = \delta_{mm^\prime}\delta_{nn^\prime}4\pi \frac{n(n+1)(n+m)!}{(2n+1)(n-m)!} |z_n^{(J)}(kr)|^2 \\
    \langle \boldsymbol{N}_{mn}^{(J)}, \boldsymbol{M}_{m^\prime n^\prime}^{(J)} \rangle
    &= \int_\Omega \boldsymbol{N}_{mn}^{(J)} \cdot \boldsymbol{M}_{m^\prime n^\prime}^{(J)*} \;d\Omega = 0
\end{split}
\end{align}


\section{Field expansions}
\textit{Electric field}
\begin{subequations}
\begin{align}
    \boldsymbol{E}_\text{src}^j &= - \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    iE_{mn} \left[ p_{mn}^{j,\text{src}} \boldsymbol{N}_{mn}^{(1)} + q_{mn}^{j,\text{src}} \boldsymbol{M}_{mn}^{(1)} \right] \\
    \boldsymbol{E}_\text{inc}^j &= - \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    iE_{mn} \left[ p_{mn}^{j,\text{inc}} \boldsymbol{N}_{mn}^{(1)} + q_{mn}^{j,\text{inc}} \boldsymbol{M}_{mn}^{(1)} \right] \\
    \boldsymbol{E}_\text{scat}^j &= \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    iE_{mn} \left[p_{mn}^{j,\text{scat}} \boldsymbol{N}_{mn}^{(3)} + q_{mn}^{j,\text{scat}} \boldsymbol{M}_{mn}^{(3)} \right] \\
    \boldsymbol{E}_\text{int}^j &= - \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    iE_{mn} \left[ d_{mn}^j \boldsymbol{N}_{mn}^{(1)} + c_{mn}^j \boldsymbol{M}_{mn}^{(1)} \right]
\end{align}
\end{subequations}

\textit{Magnetic field}
\begin{subequations}
\begin{align}
    \boldsymbol{H}_\text{src}^j &= - \sqrt{\frac{\varepsilon_b}{\mu_b}} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    E_{mn} \left[ q_{mn}^{j,\text{src}} \boldsymbol{N}_{mn}^{(1)} + p_{mn}^{j,\text{src}} \boldsymbol{M}_{mn}^{(1)} \right] \\
    \boldsymbol{H}_\text{inc}^j &= - \sqrt{\frac{\varepsilon_b}{\mu_b}} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    E_{mn} \left[ q_{mn}^j \boldsymbol{N}_{mn}^{(1)} + p_{mn}^j \boldsymbol{M}_{mn}^{(1)} \right] \\
    \boldsymbol{H}_\text{scat}^j &= \sqrt{\frac{\varepsilon_b}{\mu_b}} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    E_{mn} \left[b_{mn}^j \boldsymbol{N}_{mn}^{(3)} + a_{mn}^j \boldsymbol{M}_{mn}^{(3)} \right] \\
    \boldsymbol{H}_\text{int}^j &= -\sqrt{\frac{\varepsilon^j}{\mu^j}}  \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    E_{mn} \left[ c_{mn}^j \boldsymbol{N}_{mn}^{(1)} + d_{mn}^j \boldsymbol{M}_{mn}^{(1)} \right]
\end{align}
\end{subequations}
where $a_{mn}^j = a_n^j p_{mn}^j$, $b_{mn}^j = b_n^j q_{mn}^j$, $c_{mn}^j = c_n^j q_{mn}^j$, and $d_{mn}^j = d_n^j p_{mn}^j$; $a_n^j$, $b_n^j$, $c_n^j$, and $d_n^j$ are the ordinary Mie coefficients \cite{bohren2008absorption} of particle $j$, and $E_{mn}$ is a normalization factor
\begin{equation}
    E_{mn} = i^n \sqrt{\frac{(2n+1)(n-m)!}{n(n+1)(n+m)!}}
\end{equation}

\section{VSH translation coefficients}
The VSH functions computed in one coordinate system ($\bm{r}_j$) can be converted to a different coordinate system ($\bm{r}_l$) by use of the translation coefficients $\widetilde{A}_{mn}^{uv(J)}(l \rightarrow j)$ and $\widetilde{B}_{mn}^{uv(J)}(l \rightarrow j)$
\begin{subequations}
\begin{align}
    \bm{M}_{uv}^{(J)}(k\bm{r}_l) &= \sum_{n=0}^\infty \sum_{m=-n}^{m=n}
    \widetilde{A}_{mn}^{uv(J)}(l \rightarrow j) \bm{M}_{mn}^{(1)}(k\bm{r}_j)
    + \widetilde{B}_{mn}^{uv(J)}(l \rightarrow j) \bm{N}_{mn}^{(1)}(k\bm{r}_j) \\
    \bm{N}_{uv}^{(J)}(k\bm{r}_l) &= \sum_{n=0}^\infty \sum_{m=-n}^{m=n}
    \widetilde{B}_{mn}^{uv(J)}(l \rightarrow j) \bm{M}_{mn}^{(1)}(k\bm{r}_j)
    + \widetilde{A}_{mn}^{uv(J)}(l \rightarrow j) \bm{N}_{mn}^{(1)}(k\bm{r}_j)
\end{align}
\end{subequations}
Explicit formula for the translation coefficients can be found elsewhere. \cite{Xu_1998}

The normalized translation coefficients are defined as
\begin{subequations}
\begin{align}
    A_{mn}^{uv(J)}(l \rightarrow j) &= \frac{E_{uv}}{E_{mn}} \widetilde{A}_{mn}^{uv(J)}(l \rightarrow j) \\
    B_{mn}^{uv(J)}(l \rightarrow j) &= \frac{E_{uv}}{E_{mn}} \widetilde{B}_{mn}^{uv(J)}(l \rightarrow j)
\end{align}
\end{subequations}


\section{Interaction equations}
The interaction equations among $N$ particles can be written as
\begin{align}
    \begin{split}
        p_{mn}^{j,\text{inc}} &= p_{mn}^{j,\text{src}}  -  \sum_{l \neq j}^{(1,N)}\sum_{v=1}^{L_\text{max}} \sum_{u=-v}^{v}
        A_{mnuv}^{(3)(l \rightarrow j)} a_v^l p_{uv}^{l,\text{inc}}
        +B_{mnuv}^{(3)(l \rightarrow j)} b_v^l q_{uv}^{l,\text{inc}} \\
        q_{mn}^{j,\text{inc}} &= q_{mn}^{j,\text{src}}  -  \sum_{l \neq j}^{(1,N)}\sum_{v=1}^{L_\text{max}} \sum_{u=-v}^{v}
        B_{mnuv}^{(3)(l \rightarrow j)} a_v^l p_{uv}^{l,\text{inc}}
        +A_{mnuv}^{(3)(l \rightarrow j)} b_v^l q_{uv}^{l,\text{inc}}
    \label{eqn:gmt_system}
    \end{split}
\end{align}

\section{T-matrix formulation}
\begin{equation}
    \begin{pmatrix}
        p_{mn}^{j,\text{scat}} \\[6pt]
        q_{mn}^{j,\text{scat}}
    \end{pmatrix}
    = \sum_{v=1}^{L_\text{max}} \sum_{u=-v}^{v}
    \mathcal{T}_{mnuv}^j
    \begin{pmatrix}
        p_{uv}^{j,\text{inc}} \\[6pt]
        q_{uv}^{j,\text{inc}}
    \end{pmatrix}
    \label{eqn:t_matrix}
\end{equation}

\begin{align}
    \begin{pmatrix}
        p_{mn}^{j,\text{inc}} \\[6pt]
        q_{mn}^{j,\text{inc}} 
    \end{pmatrix}
    = 
    \begin{pmatrix}
        p_{mn}^{j,\text{src}} \\[6pt]
        q_{mn}^{j,\text{src}} 
    \end{pmatrix}
    -
    \sum_{l \neq j}^{(1,N)}\sum_{v=1}^{L_\text{max}} \sum_{u=-v}^{v}
    \sum_{v^\prime=1}^{L_\text{max}} \sum_{u^\prime=-v^\prime}^{v^\prime}
    \begin{pmatrix}
        A_{mnuv}^{(3)(l \rightarrow j)} & B_{mnuv}^{(3)(l \rightarrow j)} \\[6pt] 
        B_{mnuv}^{(3)(l \rightarrow j)} & A_{mnuv}^{(3)(l \rightarrow j)}
    \end{pmatrix}
    \mathcal{T}_{uvu^\prime v^\prime}^l
    \begin{pmatrix}
        p_{u^\prime v^\prime}^{l,\text{inc}} \\[6pt]
        q_{u^\prime v^\prime}^{l,\text{inc}}
    \end{pmatrix}
\label{eqn:gmt_system}
\end{align}

\section{Force and torque}
\emph{Maxwell stress tensor equations}
\begin{equation}
    \langle \boldsymbol{T} \rangle = \frac{1}{2} \text{Re} \left[ \varepsilon  \boldsymbol{E} \otimes \boldsymbol{E^*} + \mu \boldsymbol{H} \otimes \boldsymbol{H^*}
    - \frac{1}{2}(\varepsilon E^2 + \mu H^2)\boldsymbol{I} \right]
\end{equation}

\begin{equation}
    \langle \boldsymbol{F} \rangle = \oint_\Omega \langle \boldsymbol{T} \rangle \cdot d \boldsymbol{\Omega}
\end{equation}

\begin{equation}
    \langle \boldsymbol{\tau} \rangle = \oint_\Omega \boldsymbol{r} \times \langle \boldsymbol{T}  \rangle \cdot d \boldsymbol{\Omega}
\end{equation}

\emph{Force equations}
\begin{subequations}
\begin{align}
\begin{split}
    F_x + iF_y =& \frac{\pi}{k^2} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \frac{1}{n+1}\bigg\{
          \frac{\sqrt{(n+m+1)(n-m)}}{n}\frac{\varepsilon_b}{\mu_b}
          \bigg[2a_{mn}b_{m+1n}^*  - a_{mn}q_{m+1n}^* \\ 
        & - p_{mn} b_{m+1n}^* + 2b_{mn}a_{m+1n}^* - b_{mn}p_{m+1n}^* - q_{mn}a_{m+1n}^*  \bigg] \\
        & - \sqrt{\frac{(n+m+2)(n+m+1)n(n+2)}{(2n+3)(2n+1)}}
        \bigg[ 2 \varepsilon_b a_{mn}a_{m+1n+1}^* - \varepsilon_b a_{mn}p_{m+1n+1}^* \\
        & - \varepsilon_b p_{mn}a_{m+1n+1}^* + 2 \frac{\varepsilon_b}{\mu_b} b_{mn}b_{m+1n+1}^* - \frac{\varepsilon_b}{\mu_b} b_{mn}q_{m+1n+1}^* - \frac{\varepsilon_b}{\mu_b} q_{mn}b_{m+1n+1}^*\bigg] \\
        & + \sqrt{\frac{(n-m+1)(n-m+2)n(n+2)}{(2n+3)(2n+1)}}
        \bigg[ 2 \varepsilon_b a_{m-1n+1}a_{mn}^* - \varepsilon_b a_{m-1n+1}p_{mn}^* \\
        & - \varepsilon_b p_{m-1n+1}a_{mn}^* + 2 \frac{\varepsilon_b}{\mu_b} b_{m-1n+1}b_{mn}^* - \frac{\varepsilon_b}{\mu_b} b_{m-1n+1}q_{mn}^* - \frac{\varepsilon_b}{\mu_b} q_{m-1n+1}b_{mn}^*\bigg]
        \bigg\}
\end{split}
\end{align}

\begin{align}
\begin{split}
    F_z =& -\frac{2\pi}{k^2} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \frac{1}{n+1}\text{Re}\bigg\{
          \frac{m}{n} \frac{\varepsilon_b}{\mu_b}
          \bigg[ 2a_{mn}b_{mn}^* - a_{mn}q_{mn}^* - p_{mn}b_{mn}^* \bigg] \\
        & + \sqrt{\frac{(n-m+1)(n+m+1)n(n+2)}{(2n+3)(2n+1)}}
        \bigg[ 2 \varepsilon_b a_{mn+1}a_{mn}^* - \varepsilon_b a_{mn+1}p_{mn}^* - \varepsilon_b p_{mn+1}a_{mn}^* \\
        & + 2 \frac{\varepsilon_b}{\mu_b} b_{mn+1}b_{mn}^* - \frac{\varepsilon_b}{\mu_b} b_{mn+1}q_{mn}^* - \frac{\varepsilon_b}{\mu_b} q_{mn+1}b_{mn}^*
        \bigg] \bigg\}
\end{split}
\end{align}
\end{subequations}

\emph{Torque equations}
\begin{subequations}
\begin{align}
\begin{split}
    \tau_x =& \frac{2\pi}{k^3} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \sqrt{(n-m)(n+m+1)} \; \text{Re} \bigg\{
            \varepsilon_b a_{mn}a_{m+1n}^* + \mu_b b_{mn}b_{m+1n}^* \\
            & - \frac{1}{2} \bigg[ \varepsilon_b a_{m+1n}p_{mn}^* + \varepsilon_b a_{mn}p_{m+1n}^*
            + \mu_b b_{m+1n}q_{mn}^* + \mu_b b_{mn}q_{m+1n}^*\bigg] \bigg\}
\end{split}
\end{align}

\begin{align}
\begin{split}
    \tau_y =& \frac{2\pi}{k^3} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \sqrt{(n-m)(n+m+1)} \; \text{Im} \bigg\{
            \varepsilon_b a_{mn}a_{m+1n}^* + \mu_b b_{mn}b_{m+1n}^* \\
            & + \frac{1}{2} \bigg[ \varepsilon_b a_{m+1n}p_{mn}^* - \varepsilon_b a_{mn}p_{m+1n}^*
            + \mu_b b_{m+1n}q_{mn}^* - \mu_b b_{mn}q_{m+1n}^*\bigg] \bigg\}
\end{split}
\end{align}

\begin{align}
\begin{split}
    \tau_z =& -\frac{2\pi}{k^3} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} m \bigg\{
          \varepsilon_b |a_{mn}|^2 + \mu_b |b_{mn}|^2 - \text{Re} \bigg[
              \varepsilon_b a_{mn}p_{mn}^* + \mu_b b_{mn}q_{mn}^*\bigg] \bigg\}
\end{split}
\end{align}
\end{subequations}

\section{Cluster coefficients}
The expansion coefficients of the entire cluster $a_{mn}$, $b_{mn}$ are computed by translating the individual particle coefficients $a_{mn}^j$, $b_{mn}^j$ to the origin $\bm{p_0}$
\begin{align}
\begin{split}
    a_{mn} &= \sum_{l=1}^N\sum_{v=1}^{N_\text{max}} \sum_{u=-v}^{v}
    A_{mn}^{uv(1)}(l \rightarrow \boldsymbol{p_0}) a_{uv}^{l}
    +B_{mn}^{uv(1)}(l \rightarrow \boldsymbol{p_0}) b_{uv}^{l} \\
    b_{mn} &= \sum_{l=1}^N\sum_{v=1}^{N_\text{max}} \sum_{u=-v}^{v}
    B_{mn}^{uv(1)}(l \rightarrow \boldsymbol{p_0}) a_{uv}^{l}
    +A_{mn}^{uv(1)}(l \rightarrow \boldsymbol{p_0}) b_{uv}^{l}
\end{split}
\end{align}

\section{Far-field expansions}

\begin{align}
\begin{split}
    E_{\text{scat},\theta}(\theta,\phi) &= i\frac{e^{ikr}}{kr} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    (-i)^nE_{mn} \big[a_{mn}\tau_{mn}(\cos\theta) + b_{mn}\pi_{mn}(\cos\theta)\big] e^{im\phi} \\
    E_{\text{scat},\phi}(\theta,\phi) &= -\frac{e^{ikr}}{kr} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    (-i)^nE_{mn} \big[a_{mn}\pi_{mn}(\cos\theta) + b_{mn}\tau_{mn}(\cos\theta)\big] e^{im\phi}
\end{split}
\end{align}

\section{Cross-sections}

The cross-sections can be computed via two methods: one that uses the cluster coefficients $a_{mn}$, $b_{mn}$ and one that uses the individual particle coefficients $a_{mn}^j$, $b_{mn}^j$.

\hfill

\textit{Cross-sections via individual particle coefficients} \cite{xu1997electromagnetic}
\begin{subequations}
\begin{align}
    C_\text{abs} &= \frac{4\pi}{k^2} \sum_{j=1}^N \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    D_n^j|a_{mn}^j|^2 + C_n^j|b_{mn}^j|^2 \\
    C_\text{ext} &= \frac{4\pi}{k^2} \sum_{j=1}^N \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    \text{Re} \bigg\{ p_{mn}^{j,\text{src}*} a_{mn}^j 
    + q_{mn}^{j,\text{src}*}b_{mn}^j \bigg\} \\
    C_\text{scat} &= C_\text{ext} - C_\text{abs}
\end{align}
\end{subequations}
where
\begin{subequations}
\begin{align}
    D_n^j &= \frac{\text{Re}\{ im^j \mu_b \mu^j \psi_n(y^j)\psi_n^{\prime *}(y^j)\}}
    {|\mu_b m^j \psi_n(y^j)\psi_n^\prime(x^j) - \mu^j \psi_n(x^j)\psi_n^\prime(y^j)|^2} \\
    C_n^j &= \frac{\text{Re}\{ im^{j*} \mu_b \mu^j \psi_n(y^j)\psi_n^{\prime *}(y^j)\}}
    {|\mu^j \psi_n(y^j)\psi_n^\prime(x^j) - \mu_b m^j \psi_n(x^j)\psi_n^\prime(y^j)|^2}
\end{align}
\end{subequations}
and $m_j = n^j/n_b$, $x^j = k r^j$, $y^j = m^jx^j$ and $\psi_n$ is the Riccati-Bessel function of the first kind.
This approach is the most efficient way to compute the total cross-sections.
Each term in the absorption/extinction cross-section sum can be interpreted as the absorption/extinction of that individual particle due to a given mode $(n,m)$

\hfill

\textit{Cross-sections via cluster coefficients} \cite{xu1995electromagnetic}
\begin{subequations}
\begin{align}
    C_\text{scat} &= \frac{4\pi}{k^2} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    |a_{mn}|^2 + |b_{mn}|^2 \\
    C_\text{ext} &= \frac{4\pi}{k^2} \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n}
    \text{Re} \bigg\{ p_{mn}^{\text{src}*}(\boldsymbol{p_0}) a_{mn} 
    + q_{mn}^{\text{src}*}(\boldsymbol{p_0})b_{mn} \bigg\} \\
    C_\text{abs} &= C_\text{ext} - C_\text{scat}
\end{align}
\end{subequations}
This approach has a benefit in its interpretation.
Each term in the scattering sum corresponds to the multipolar scattering of order $(n,m)$, so that the scattering from the entire cluster can be identified as electric or magnetic in nature, dipole, quadrupole, etc.
These equations should typically be avoided in calculating total cross-sections since there is a loss of information in using the cluster coefficients and they may not converge.

All of these cross-sections have units of (area)$\times$(electric field)$^2$.
If the source is a plane wave of amplitude $E_0$, then these cross-sections should be normalized by $E_0^2$.
For non-plane wave sources, the cross-sections should be normalized depending on the convention being used, typically an averaged intensity over some area:
\begin{equation}
    E_0^2 = \frac{1}{A} \int_A |\boldsymbol{E}(\boldsymbol{r})|^2 \;dA
\end{equation}

\section{Source decomposition}
Given the fields of the incident source $\boldsymbol{E}_\text{src}(\boldsymbol{r})$, $\boldsymbol{H}_\text{src}(\boldsymbol{r})$, the source can be decomposed by integration
\begin{align}
\begin{split}
    p_{mn}^{j,\text{src}} &= i\cfrac{\int_\Omega \boldsymbol{E}_\text{src} \cdot \boldsymbol{N}_{mn}^{(1)*} \; d\Omega}
    {E_{mn} \langle \boldsymbol{N}_{mn}^{(1)},\boldsymbol{N}_{mn}^{(1)} \rangle} \\
    q_{mn}^{j,\text{src}} &= i\cfrac{\int_\Omega \boldsymbol{E}_\text{src} \cdot \boldsymbol{M}_{mn}^{(1)*} \; d\Omega}
    {E_{mn} \langle \boldsymbol{M}_{mn}^{(1)},\boldsymbol{M}_{mn}^{(1)} \rangle}
\end{split}
\end{align}
where $\Omega$ is a closed surface around particle $j$.

For a plane wave, the decomposition can be carried out analytically.
For a TM mode with incident polar angle $\alpha$ and azimuthal angle $\beta$
\begin{align}
\begin{split}
p_{mn}^{j,\text{src}} &= E_0 i^{-n} E_{mn} \tau_{mn}(\cos \alpha) \exp(-im\beta) \exp(i\bm{k} \cdot \bm{r}_j) \\
q_{mn}^{j,\text{src}} &= E_0 i^{-n} E_{mn} \pi_{mn}(\cos \alpha) \exp(-im\beta) \exp(i\bm{k} \cdot \bm{r}_j)
\end{split}
\end{align}

\section{Efficient numeric evaluation}
\section{Recursion relations}

\section{Other conventions}
A different convention for the field expansions used in other work \cite{barton1989theoretical} is presented here.
These field expansions were used to evaluate analytic expressions for the force and torque.
\newline

\textit{Electric field}
\begin{subequations}
\begin{align}
\begin{split}
    \boldsymbol{E}_\text{inc}^j = \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \bigg\{
    \boldsymbol{\hat r}\frac{1}{r^2} &\bigg[ n(n+1) p_{mn}^j \psi_n(kr) Y_{nm}(\theta,\phi) \bigg] \\
    +\; \boldsymbol{\hat \theta}\frac{k}{r} &\left[ p_{mn}^j \psi_n^\prime(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi)
    - \frac{m}{\sqrt{\varepsilon_b}} q_{mn}^j \psi_n(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta} \right] \\
    +\; \boldsymbol{\hat \phi}\frac{k}{r} &\left[ im p_{mn}^j \psi_n^\prime(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta}
    - \frac{i}{\sqrt{\varepsilon_b}} q_{mn}^j \psi_n(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi) \right] \bigg\}
\end{split}
\end{align}
\begin{align}
\begin{split}
    \boldsymbol{E}_\text{scat}^j = \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \bigg\{
    \boldsymbol{\hat r}\frac{1}{r^2} &\bigg[ n(n+1) a_{mn}^j \xi_n^{(1)}(kr) Y_{nm}(\theta,\phi) \bigg] \\
    +\; \boldsymbol{\hat \theta}\frac{k}{r} &\left[ a_{mn}^j \xi_n^{(1)\prime}(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi)
    - \frac{m}{\sqrt{\varepsilon_b}} b_{mn}^j \xi_n^{(1)}(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta} \right] \\
    +\; \boldsymbol{\hat \phi}\frac{k}{r} &\left[ im a_{mn}^j \xi_n^{(1)\prime}(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta}
    - \frac{i}{\sqrt{\varepsilon_b}} b_{mn}^j \xi_n^{(1)}(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi) \right] \bigg\}
\end{split}
\end{align}
\end{subequations}

\textit{Magnetic field}
\begin{subequations}
\begin{align}
\begin{split}
    \boldsymbol{H}_\text{inc}^j = \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \bigg\{
    \boldsymbol{\hat r}\frac{1}{r^2} &\bigg[ n(n+1) q_{mn}^j \psi_n(kr) Y_{nm}(\theta,\phi) \bigg] \\
    +\; \boldsymbol{\hat \theta}\frac{k}{r} &\left[ q_{mn}^j \psi_n^\prime(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi)
    + m\sqrt{\varepsilon_b} p_{mn}^j \psi_n(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta} \right] \\
    +\; \boldsymbol{\hat \phi}\frac{k}{r} &\left[ im q_{mn}^j \psi_n^\prime(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta}
    + i\sqrt{\varepsilon_b} p_{mn}^j \psi_n(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi) \right] \bigg\}
\end{split}
\end{align}
\begin{align}
\begin{split}
    \boldsymbol{H}_\text{scat}^j = \sum_{n=1}^{N_\text{max}} \sum_{m=-n}^{n} \bigg\{
    \boldsymbol{\hat r}\frac{1}{r^2} &\bigg[ n(n+1) b_{mn}^j \xi_n^{(1)}(kr) Y_{nm}(\theta,\phi) \bigg] \\
    +\; \boldsymbol{\hat \theta}\frac{k}{r} &\left[ n_{mn}^j \xi^{(1)\prime}(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi)
    + m\sqrt{\varepsilon_b} a_{mn}^j \xi_n^{(1)}(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta} \right] \\
    +\; \boldsymbol{\hat \phi}\frac{k}{r} &\left[ im b_{mn}^j \xi_n^{(1)\prime}(kr) \frac{Y_{nm}(\theta,\phi)}{\sin\theta}
    + i\sqrt{\varepsilon_b} a_{mn}^j \xi_n^{(1)}(kr) \frac{\partial}{\partial \theta} Y_{nm}(\theta,\phi) \right] \bigg\}
\end{split}
\end{align}
\end{subequations}
where $\xi_n^{(1)} = \psi_n - i \chi_n$, $\psi_n$, $\chi_n$ are the Riccati-Bessel function of the first and second kind, and $Y_{nm}$ are the spherical harmonics
\begin{align}
\begin{split}
    \psi_n(x) &= xj_n(x) \\
    \chi_n(x) &= -xy_n(x) \\
    \xi_n^{(1)}(x) &= x[j_n(x) + iy_n(x)] = xh_n^{(1)}(x) \\
    Y_{nm}(\theta, \phi) &= \sqrt{\frac{2n+1}{4\pi}\frac{(n-m)!}{(n+m)!}} P_n^m(\cos \theta) e^{im\phi}
\end{split}
\end{align}

Denoting the coefficients of our convention $\bar a_n$, $\bar b_n$, $\bar p_{mn}$, $\bar q_{mn}$, $\bar a_{mn}$, $\bar b_{mn}$, the two conventions are related by
\begin{align}
\begin{split}
    \bar a_{n} &= - a_{n} \\
    \bar b_{n} &= - b_{n} \\
    \bar p_{mn} &= \frac{k^2}{i^{n-1}}\sqrt{\frac{n(n+1)}{4\pi}} p_{mn} \\
    \bar q_{mn} &= -\frac{k^2}{i^n}\sqrt{\frac{\mu_b}{\varepsilon_b} \frac{n(n+1)}{4\pi}} q_{mn} \\
    \bar a_{mn} &= -\frac{k^2}{i^{n-1}}\sqrt{\frac{n(n+1)}{4\pi}} a_{mn} \\
    \bar b_{mn} &= \frac{k^2}{i^n}\sqrt{\frac{\mu_b}{\varepsilon_b} \frac{n(n+1)}{4\pi}} b_{mn}
\end{split}
\end{align}
Another convention uses a different value for the $E_{mn}$ normalization values \cite{xu1995electromagnetic}
\begin{equation}
    E_{mn} = |E_0|i^n \frac{2n+1}{n(n+1)}
\end{equation}
where $|E_0|$ is the amplitude of the source field.
We have chosen to absorb this amplitude into the $a$, $b$, $p$, and $q$ coefficients.

\section{MiePy}

Example Python code using MiePy
\begin{lstlisting}
    import miepy
    nm = 1e-9

    # define material and source
    Ag = miepy.materials.Ag()
    source = miepy.sources.plane_wave(polarization=[1,0])

    # build an Ag dimer with radii 50nm separated by 600nm in the x-direction
    dimer = miepy.sphere_cluster(position=[[300*nm,0,0], [-300*nm,0,0]],
                                    radius=50*nm,
                                    material=Ag,
                                    source=source,
                                    wavelength=800*nm,
                                    lmax=2)

    # obtain the cross-sections
    scat, absorb, extinct = dimer.cross_sections()

    # obtain the force and torque on the right particle
    F = dimer.force_on_particle(0)
    T = dimer.torque_on_particle(0)
\end{lstlisting}

\section{Target features}

\begin{enumerate*}
    \item \textbf{version 0.3}
        \begin{itemize}[label={\tiny\raisebox{1ex}{\textbullet}}]
            \item 30x performance for larger clusters
            \item T-matrix for non-spherical particles
            \item Plane-wave/beams direction and polarization control
        \end{itemize}
    \item \textbf{version 0.4}
        \begin{itemize}[label={\tiny\raisebox{1ex}{\textbullet}}]
            \item Periodic boundary conditions (1D and 2D)
            \item Symmetry relationships (mirror, anti-mirror, discrete rotation, inversion)
            \item Additional performance: 
                        (i) A/B remainging symmetries, 
                        (ii) lmax per particle,
                        (iii) source=None for pre-computed aggregate T-matrix,
                        (iv) no T-matrix recomputation for identical geometries
                        (v) transition from [[2,rmax]] $\rightarrow$ [[rmax]] shape
            \item Save solution so that it can be reloaded
            \item Any changes to T-matrix/sources
        \end{itemize}
    \item \textbf{version 0.5}
        \begin{itemize}[label={\tiny\raisebox{1ex}{\textbullet}}]
            \item Additional functions: 
                       (i) cluster T-matrix,
                       (ii) Mueller matrix,
                       (iii) spin vs. orbital torque,
                       (iv) local density of states,
                       (v) energy and momentum density
            \item Average over orientations calculations
            \item Existing TODO items
            \item Better documentation, examples, tests, and tutorial/introduction for quick introduction
        \end{itemize}
    \item \textbf{future}
        \begin{itemize}[label={\tiny\raisebox{1ex}{\textbullet}}]
            \item Substrates, layered substrates
            \item Beyond the Rayleigh hypothesis for non-spherical particle interactions
            \item More T-matrix options:
                        (i) non-axisymmetric particles, Gaussian spheres/cylinders, layered spheres/spheroids, etc.
                        (ii) chiral materials,
                        (iii) anisotropic materials
                    \item Valid field expansion in circumscribing spheres (possibly using discrete sources)
            \item 3D periodic boundary conditions
            \item Band diagram calculations
            \item Performance:
                      (i) parallelization (MPI, openMP, and/or GPU),
                      (ii) C++ implementations,
                      (iii) approximation for long-range interactions in large systems,
                      (iv) Preconditioner for iterative matrix solver
            \item Scene visualization (3D)
            \item Prettier output for main classes using \_\_repr\_\_
            \item Time-domain via IFFT
        \end{itemize}
\end{enumerate*}


\bibliographystyle{unsrt}
\bibliography{generalized_mie_theory.bib}{}

\end{document}
